<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iFlex Stretch Planner</title>
  <!-- Tailwind CSS: utility-first styling framework -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <!-- Google Fonts: Inter family -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- jsPDF UMD bundle for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Ensure consistent font across browsers */
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-white text-black dark:bg-gray-900 dark:text-gray-100 min-h-screen p-6">

  <!-- Header: logo + dark mode toggle -->
  <header class="max-w-3xl mx-auto flex justify-between items-center mb-6">
    <img src="https://res.cloudinary.com/dn1saqddq/image/upload/c_thumb,w_200,g_face/v1747813392/iflex_logo_publish_defngt.png"
         alt="iFlex Logo" class="h-12" />
    <button id="darkToggle"
            class="px-4 py-2 rounded-full border focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f9d22dff]">
      Toggle Dark Mode
    </button>
  </header>

  <!-- Main container: form and output -->
  <main class="max-w-3xl mx-auto bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-10 space-y-8 border border-[#f9d22dff]">
    <section aria-labelledby="title">
      <h1 id="title" class="text-4xl font-extrabold text-center">iFlex Stretch Planner</h1>
      <p class="text-center text-gray-600 dark:text-gray-300">
        Create custom 12-month follow-up plans using voice notes or text input.
      </p>
    </section>

    <!-- Planner form -->
    <form id="plannerForm" class="space-y-8">

      <!-- Client Info fields -->
      <section aria-labelledby="client-info" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <!-- Client Name -->
        <div>
          <label for="clientName" class="block text-sm font-semibold mb-2">Client Name</label>
          <input id="clientName" name="clientName" type="text" required
                 class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-black dark:text-gray-100 focus:ring-[#f9d22dff] focus:border-[#f9d22dff]" />
        </div>
        <!-- Session Date -->
        <div>
          <label for="clientDate" class="block text-sm font-semibold mb-2">Session Date</label>
          <input id="clientDate" name="clientDate" type="date" required
                 class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-black dark:text-gray-100 focus:ring-[#f9d22dff] focus:border-[#f9d22dff]" />
        </div>
        <!-- Therapist selection -->
        <div>
          <label for="therapistName" class="block text-sm font-semibold mb-2">Stretch Therapist</label>
          <select id="therapistName" name="therapistName" required
                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-black dark:text-gray-100 focus:ring-[#f9d22dff] focus:border-[#f9d22dff]">
            <option value="">Select</option>
            <option>Austin Martinez</option>
            <option>Verdine Baker</option>
          </select>
        </div>
      </section>

      <!-- Session Details and Notes -->
      <section aria-labelledby="session-details" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Session Type dropdown -->
        <div>
          <label for="sessionType" class="block text-sm font-semibold mb-2">Session Type</label>
          <select id="sessionType" name="sessionType"
                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-black dark:text-gray-100 focus:ring-[#f9d22dff] focus:border-[#f9d22dff]">
            <!-- All 21 options covered with matching guidance keys -->
            <option>General Flexibility</option>
            <option>Enhanced Flexibility</option>
            <option>Injury Prevention</option>
            <option>Pain Relief</option>
            <option>Faster Recovery</option>
            <option>Improved Posture</option>
            <option>Personalized Sessions</option>
            <option>Stress Reduction</option>
            <option>Enhanced Athletic Performance</option>
            <option>Better Circulation</option>
            <option>Increased Energy Levels</option>
            <option>Mind‚ÄìBody Connection</option>
            <option>Safe, Low-Impact Care</option>
            <option>Pre-Workout Activation</option>
            <option>Post-Workout Cool-Down</option>
            <option>Pain-Free Movement in Daily Life</option>
            <option>Mobility for Desk Workers</option>
            <option>Complementary to Physical Therapy</option>
            <option>Expertise in Movement Mechanics</option>
            <option>Goal-Oriented Programming</option>
            <option>Consistent Accountability</option>
          </select>
        </div>
        <!-- Notes textarea with voice input -->
        <div>
          <label for="notes" class="block text-sm font-semibold mb-2">Session Notes</label>
          <textarea id="notes" name="notes" rows="4"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-black dark:text-gray-100 focus:ring-[#f9d22dff] focus:border-[#f9d22dff]"></textarea>
          <!-- Mic button toggles SpeechRecognition -->
          <button type="button" id="micBtn" aria-pressed="false" aria-label="Start voice input"
                  class="mt-2 inline-flex items-center gap-2 bg-black text-white px-4 py-2 rounded-xl shadow transition-all">
            üé§ <span>Start Voice Input</span>
          </button>
        </div>
      </section>

      <!-- Progress Check-Ins -->
      <section aria-labelledby="progress-check-ins">
        <h2 id="progress-check-ins" class="block text-sm font-semibold mb-2">Progress Check-Ins</h2>
        <textarea id="progress" name="progress" rows="5"
                  class="w-full p-3 border border-yellow-300 rounded-xl h-28 bg-yellow-50 placeholder-gray-500 focus:ring-[#f9d22dff] focus:border-[#f9d22dff] text-black"></textarea>
      </section>

 <!-- Action buttons -->
<section aria-labelledby="actions">
  <button type="button" id="generateBtn" disabled
          class="w-full bg-[#f9d22dff] dark:bg-yellow-500 hover:bg-yellow-400 text-black text-lg font-semibold px-6 py-4 rounded-2xl shadow-md transition-all flex items-center justify-center gap-2"
          aria-busy="false">
    <span id="generateText">‚ú® Generate Personalized Plan</span>
    <svg id="spinner" role="status" aria-hidden="true"
         class="hidden animate-spin h-5 w-5 text-black ml-2"
         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
  </button>
</section>

      <!-- Output textarea and PDF/print buttons -->
      <section aria-labelledby="output-plan">
        <h2 id="output-plan" class="block text-sm font-semibold mb-2">Suggested Follow-Up Plan</h2>
        <textarea id="output" rows="8"
                  class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-2xl bg-gray-100 dark:bg-gray-700 text-black dark:text-gray-100 focus:outline-none"
                  aria-live="polite" readonly></textarea>
        <button type="button" id="savePdfBtn" disabled
                class="mt-4 w-full bg-black dark:bg-gray-700 hover:bg-gray-900 dark:hover:bg-gray-600 text-white font-medium py-3 rounded-xl shadow focus:outline-none">
          üíæ Save Plan as PDF
        </button>
        <button type="button" id="printPdfBtn" disabled
                class="mt-2 w-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-black dark:text-white font-medium py-3 rounded-xl shadow focus:outline-none">
          üñ®Ô∏è Print Plan
        </button>
      </section>
    </form>
  </main>

  <script>
    // ========== Knowledge Base Guidance ==========
    // Maps each sessionType to its guiding instructions
    const knowledgeBase = {
  
  "General Flexibility": "Incorporate a mix of PNF, dynamic, and static stretching. Focus on key areas like hips, hamstrings, and shoulders. Include breathwork and end-range holds to deepen flexibility gains.",
  
  "Enhanced Flexibility": "Use partner-assisted stretching and progressive intensity. Track improvements weekly and adjust protocols based on range of motion testing.",
  
  "Injury Prevention": "Reinforce weak points, activate stabilizing muscles, and use controlled mobility drills to enhance joint integrity and prevent strain.",
  
  "Pain Relief": "Employ gentle myofascial release, sustained static holds, and neuromuscular inhibition to ease discomfort and release tension.",
  
  "Faster Recovery": "Prioritize soft tissue work, dynamic mobility, and light movement to support recovery between sessions or workouts.",
  
  "Improved Posture": "Incorporate thoracic spine mobilization, scapular stabilization, and corrective flexibility to support upright alignment.",
  
  "Personalized Sessions": "Adapt sessions based on mobility assessments, ongoing progress, and direct client feedback to optimize outcomes.",
  
  "Stress Reduction": "Use diaphragmatic breathing, slow static stretching, and gentle, meditative movements to calm the nervous system.",
  
  "Enhanced Athletic Performance": "Blend sport-specific dynamic drills with proprioceptive neuromuscular facilitation to support explosive movement and joint control.",
  
  "Better Circulation": "Incorporate rhythmic full-body movements and gradient stretching patterns to promote healthy blood flow.",
  
  "Increased Energy Levels": "Use dynamic warm-up flows and neuromuscular activation to energize the body and prepare it for action.",
  
  "Mind‚ÄìBody Connection": "Enhance focus and relaxation through mindful breathing, intentional pacing, and visualization during stretching.",
  
  "Safe, Low-Impact Care": "Deliver joint-safe, controlled mobility work with gradual progressions‚Äîideal for all ages and experience levels.",
  
  "Pre-Workout Activation": "Prime key muscle groups using dynamic drills and mobility prep sequences to boost performance and reduce injury risk.",
  
  "Post-Workout Cool-Down": "Aid recovery and flexibility using static holds, breathwork, and targeted release techniques.",
  
  "Pain-Free Movement in Daily Life": "Target mobility restrictions that impact everyday activities like standing, sitting, or reaching. Customize accordingly.",
  
  "Mobility for Desk Workers": "Focus on hip flexor release, thoracic spine mobility, and shoulder opening to counteract prolonged sitting.",
  
  "Complementary to Physical Therapy": "Support rehab goals by layering in gentle mobility and joint control techniques that align with PT protocols.",
  
  "Expertise in Movement Mechanics": "Include biomechanically-informed corrections, stability work, and end-range control to enhance movement efficiency.",
  
  "Goal-Oriented Programming": "Set and review weekly flexibility and mobility goals. Adjust plans based on tangible improvements and session outcomes.",
  
  "Consistent Accountability": "Establish a routine with regular check-ins, reassessments, and motivational support to keep clients progressing."
    };

    // ========== Speech Recognition Setup ==========
    let recognition;
    try {
      // Define browser-specific constructors
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;   // keep capturing
      recognition.interimResults = true; // get partial results
      recognition.lang = 'en-US';      // set language
    } catch {
      // Disable mic button and show warning if not supported
      document.getElementById('micBtn').disabled = true;
      const warn = document.createElement('p');
      warn.textContent = 'Voice input not supported in this browser.';
      warn.className = 'text-red-500 text-sm mt-2';
      document.getElementById('notes').after(warn);
    }

    // ========== Dark Mode Persistence ==========
    document.getElementById('darkToggle').addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
    });
    window.addEventListener('DOMContentLoaded', () => {
      // Apply saved dark-mode preference on load
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
      }
      // Restore saved form values
      ['clientName','clientDate','therapistName','notes','progress'].forEach(id => {
        const val = localStorage.getItem(id);
        if (val) document.getElementById(id).value = val;
      });
      validateForm();
    });

    // ========== Form Validation & Persistence ==========
    const clientName    = document.getElementById('clientName');
    const clientDate    = document.getElementById('clientDate');
    const therapistName = document.getElementById('therapistName');
    const notesEl       = document.getElementById('notes');
    const progressEl    = document.getElementById('progress');
    const generateBtn   = document.getElementById('generateBtn');
    const savePdfBtn    = document.getElementById('savePdfBtn');
    const printPdfBtn   = document.getElementById('printPdfBtn');

    function validateForm() {
      // Enable generate button only when required fields are filled
      generateBtn.disabled = !(clientName.value.trim() && clientDate.value && therapistName.value);
    }
    // Persist inputs to localStorage on change
    ['clientName','clientDate','therapistName','notes','progress'].forEach(id => {
      document.getElementById(id).addEventListener('input', (e) => {
        localStorage.setItem(id, e.target.value || '');
        validateForm();
      });
    });

    // ========== Voice Input Handling ==========
    const micBtnEl = document.getElementById('micBtn');
    let finalTranscript = '';
    micBtnEl.addEventListener('click', () => {
      if (!recognition) return;
      // Toggle listening state
      const listening = micBtnEl.classList.toggle('listening');
      micBtnEl.setAttribute('aria-pressed', listening);
      micBtnEl.querySelector('span').textContent = listening ? 'Listening‚Ä¶' : 'Start Voice Input';
      if (listening) {
        finalTranscript = ''; // reset any previous transcript
        micBtnEl.classList.add('bg-yellow-200','text-black','animate-pulse');
        micBtnEl.classList.remove('bg-black','text-white');
        recognition.start();
      } else {
        micBtnEl.classList.remove('bg-yellow-200','text-black','animate-pulse');
        micBtnEl.classList.add('bg-black','text-white');
        recognition.stop();
      }
    });
    if (recognition) {
      recognition.onresult = event => {
        let interim = '';
        // Aggregate final vs interim transcripts
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const { transcript } = event.results[i][0];
          event.results[i].isFinal ? finalTranscript += transcript : interim += transcript;
        }
        notesEl.value = finalTranscript + interim;
      };
      recognition.onend = () => {
        // Auto-restart if still listening
        if (micBtnEl.classList.contains('listening')) recognition.start();
      };
    }

    // ========== Image to DataURL Helper ==========
    // Loads an image and converts to base64, with CORS handling and fallback
    async function getImageDataUrl(url) {
      try {
        return await new Promise((res, rej) => {
          const img = new Image(); img.crossOrigin = 'anonymous';
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            canvas.getContext('2d').drawImage(img, 0, 0);
            res(canvas.toDataURL('image/png'));
          };
          img.onerror = rej;
          img.src = url;
        });
      } catch {
        console.warn('Logo load failed');
        return null; // graceful degradation
      }
    }

    // ========== PDF Generation ==========
    let lastPdfDoc = null;
    function generatePdfSync() {
      // Create a new jsPDF instance (letter size, points unit)
      const doc = new window.jspdf.jsPDF({ unit:'pt', format:'letter' });
      const pw = doc.internal.pageSize.getWidth();
      const ph = doc.internal.pageSize.getHeight();
      const margin = 40, lineHeight = 14;
      let y = margin;

      // Add logo if available
      return getImageDataUrl(document.querySelector('header img').src)
        .then(imgData => {
          if (imgData) {
            const props = doc.getImageProperties(imgData);
            const imgWidth = 100;
            const imgHeight = (props.height * imgWidth) / props.width;
            doc.addImage(imgData, 'PNG', (pw - imgWidth) / 2, y, imgWidth, imgHeight);
            y += imgHeight + 20;
          }

          // Add header text
          doc.setFontSize(16).text('iFlex Stretch Plan', margin, y); y += lineHeight * 2;
          doc.setFontSize(12)
             .text(`Client: ${clientName.value}`, margin, y); y += lineHeight;
          const dateStr = new Date(clientDate.value).toLocaleDateString('en-US',
            { year: 'numeric', month: 'long', day: 'numeric' });
          doc.text(`Date: ${dateStr}`, margin, y); y += lineHeight;
          doc.text(`Therapist: ${therapistName.value}`, margin, y); y += lineHeight * 2;

          // Add progress notes if present
          if (progressEl.value) {
            doc.text('Progress Notes:', margin, y); y += lineHeight;
            doc.splitTextToSize(progressEl.value, pw - 2 * margin)
              .forEach(line => {
                if (y + lineHeight > ph - margin) { doc.addPage(); y = margin; }
                doc.text(line, margin, y); y += lineHeight;
              });
            y += lineHeight;
          }

          // Add plan content
          doc.text('Plan:', margin, y); y += lineHeight;
          doc.splitTextToSize(document.getElementById('output').value, pw - 2 * margin)
            .forEach(line => {
              if (y + lineHeight > ph - margin) { doc.addPage(); y = margin; }
              doc.text(line, margin, y); y += lineHeight;
            });

          lastPdfDoc = doc;
          return doc;
        });
    }

    // Save PDF file
    document.getElementById('savePdfBtn').addEventListener('click', () => {
      generatePdfSync().then(doc => {
        const safeName = clientName.value.trim().replace(/\s+/g, '_') || 'plan';
        doc.save(`iFlex_Stretch_Plan_${safeName}.pdf`);
      });
    });

    // Print PDF in new window
    document.getElementById('printPdfBtn').addEventListener('click', () => {
      (lastPdfDoc ? Promise.resolve(lastPdfDoc) : generatePdfSync())
        .then(doc => {
          const url = doc.output('bloburl');
          const printWin = window.open(url);
          if (printWin) printWin.onload = () => printWin.print();
        });
    });

    // ========== Plan Generation ==========
    document.getElementById('generateBtn').addEventListener('click', async () => {
      // Gather form inputs
      const sessionType = document.getElementById('sessionType').value;
      const notesText   = notesEl.value || '';
      const client      = clientName.value;
      const therapist   = therapistName.value;
      const rawDate     = clientDate.value;
      const formatted   = isNaN(new Date(rawDate))
                          ? ''
                          : new Date(rawDate).toLocaleDateString('en-US',
                              { year:'numeric', month:'long', day:'numeric' });
      const progress    = progressEl.value || '';
      const outputEl    = document.getElementById('output');

      // Provide user feedback during API call
      outputEl.value = 'Generating your customized 12-month iFlex stretch therapy plan...';
      generateBtn.disabled = true;
      savePdfBtn.disabled  = true;
      printPdfBtn.disabled = true;
      document.getElementById('generateText').classList.add('hidden');
      document.getElementById('spinner').classList.remove('hidden');

      // Build prompt using knowledgeBase guidance
      const guidance = knowledgeBase[sessionType] || '';
      try {
        const response = await fetch('/api/generate-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionType,
            notes: `You are a certified stretch therapist at iFlex. You are writing a warm letter to a client after a session. Write a 12 month plan for the client to help them achieve their flexibility and mobility goals. Break it down by month. Include how many times per week to come into iflex. Add your signature at the bottom.  Use guidance for '${sessionType}': ${guidance}. Based on notes '${notesText}', progress '${progress}', client '${client}', therapist '${therapist}', date '${formatted}'.`
          })
        });
        const data = await response.json();
        outputEl.value = data.plan || 'Error generating plan.';
        if (data.plan) {
          // Enable save/print on success
          savePdfBtn.disabled  = false;
          printPdfBtn.disabled = false;
          lastPdfDoc = null; // reset cache
        }
      } catch (error) {
        console.error(error);
        outputEl.value = '‚ùóÔ∏è Couldn‚Äôt generate your plan. Try again later.';
      } finally {
        // Restore button state
        generateBtn.disabled = false;
        document.getElementById('generateText').classList.remove('hidden');
        document.getElementById('spinner').classList.add('hidden');
      }
      const generateBtn = document.getElementById('generateBtn');
const generateText = document.getElementById('generateText');
const spinner = document.getElementById('spinner');
const output = document.getElementById('output');

generateBtn.addEventListener('click', async () => {
  // Set button to busy state
  generateBtn.setAttribute('aria-busy', 'true');
  generateBtn.disabled = true;
  generateText.classList.add('hidden');
  spinner.classList.remove('hidden');

  // Simulate a short delay (replace this with real fetch if needed)
  await new Promise(res => setTimeout(res, 1200));

  // Update output (replace this with your real generation logic)
  output.value = '‚úÖ Your custom 12-month iFlex Stretch Plan is ready!';

  // Re-enable button
  spinner.classList.add('hidden');
  generateText.classList.remove('hidden');
  generateBtn.disabled = false;
  generateBtn.setAttribute('aria-busy', 'false');

  // Show confetti
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 }
  });

  // Enable save button
  savePdfBtn.disabled = false;
});
    });
  </script>
</body>
</html>
